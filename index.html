<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Splitwise Lite - Add Expense</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .participants-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 8px 0;
    }
    .participants-list label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    button { padding: 10px 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’° Malvana Trip - Add Expense</h1>
    <form id="expenseForm">
      <label>Description</label>
      <input type="text" id="desc" required>

      <label>Amount</label>
      <input type="number" id="amt" required>

      <label>Paid By</label>
      <select id="paidBy" required></select>

      <label>Share it with</label>
      <div id="participants" class="participants-list"></div>

      <button type="submit">Add Expense</button>
    </form>
    <p id="message"></p>
    <a href="dashboard.html">ðŸ“Š View Dashboard</a>
  </div>

  <script>
    // ========================
    // CONFIG: Replace with your Web App /exec URL
    const API_URL = "https://script.google.com/macros/s/AKfycbzOfnc7GHLz5WzyxV5Gskfq0b8t9cqS2fAdlTh8ApSCwbuWdyKfmT3ftigmFqzh0bjAbg/exec";
    // ========================

    // Load users from Google Sheets (GET /getUsers)
    async function loadUsers() {
      try {
        const res = await fetch(`${API_URL}?action=getUsers`);
        const users = await res.json();

        // Paid By dropdown
        const paidBySelect = document.getElementById("paidBy");
        users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.name; // Name, backend converts â†’ UserID
          opt.textContent = u.name;
          paidBySelect.appendChild(opt);
        });

        // Participants checkboxes
        const participantsDiv = document.getElementById("participants");
        users.forEach(u => {
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = u.name;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(u.name));
          participantsDiv.appendChild(label);
        });

      } catch (err) {
        console.error("Error loading users:", err);
        document.getElementById("message").textContent =
          "âš ï¸ Failed to load users. Check API URL.";
      }
    }

    // Submit Add Expense form (POST /addExpense)
    async function addExpense() {
      const desc = document.getElementById("desc").value;
      const amt = parseFloat(document.getElementById("amt").value);
      const paidBy = document.getElementById("paidBy").value;

      const participants = Array.from(
        document.querySelectorAll("#participants input:checked")
      ).map(cb => cb.value);

      if (participants.length === 0) {
        document.getElementById("message").textContent = "âš ï¸ Select at least one participant.";
        return;
      }

      const payload = {
        action: "addExpense",
        group: "Malvana Trip",
        description: desc,
        amount: amt,
        paidBy: paidBy,
        participants: participants
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.status === "success") {
          document.getElementById("message").textContent = "âœ… Expense added!";
          document.getElementById("expenseForm").reset();
        } else {
          document.getElementById("message").textContent = "âš ï¸ Error: " + data.message;
        }
      } catch (err) {
        document.getElementById("message").textContent = "âš ï¸ Network error: " + err.message;
      }
    }

    // Event listeners
    document.addEventListener("DOMContentLoaded", () => {
      loadUsers();
      const form = document.getElementById("expenseForm");
      form.addEventListener("submit", async e => {
        e.preventDefault();
        await addExpense();
      });
    });
  </script>
</body>
</html>
